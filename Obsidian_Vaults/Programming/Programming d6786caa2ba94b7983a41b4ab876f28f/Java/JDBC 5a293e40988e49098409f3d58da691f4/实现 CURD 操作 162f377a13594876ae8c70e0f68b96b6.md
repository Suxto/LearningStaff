# 实现 CURD 操作

CURD→增删改查

- 数据库连接被用于向数据库服务器发送命令和 `SQL` 语句，并接受数据库服务器返回的结果。其实一个数据库连接就是一个 `Socket` 连接。
- 在 `java.sql` 包中有 3 个接口分别定义了对数据库的调用的不同方式：
    - `Statement` ：用于执行静态 SQL 语句并返回它所生成结果的对象。(不用这个）
    - `PrepatedStatement` ： `SQL` 语句被预编译并存储在此对象中，可以使用此对象多次高效地执行该语句。
    - `CallableStatement`：用于执行 SQL 存储 **过程**

![Untitled](Programming/Programming%20d6786caa2ba94b7983a41b4ab876f28f/Java/JDBC%205a293e40988e49098409f3d58da691f4/实现%20CURD%20操作%20162f377a13594876ae8c70e0f68b96b6/Untitled.png)

## 为什么不用 `Statement`

主要有两个原因：

1. 需要拼接 `SQL` 指令字符串
2. 有可能被恶意 `SQL` 注入
    - SQL 注入是利用某些系统没有对用户输入的数据进行充分的检查，而在用户输入数据中注入非法的 SQL 语句段或命令(如： `SELECT user, password FROM user_table WHERE user='a' OR 1 = ' AND password = ' OR '1' = '1'` ) ，从而利用系统的 SQL 引擎完成恶意行为的做法。
    - 可以通过更换为 `PreparedStatement` 解决。
    - 图解
        
        ![Untitled](Programming/Programming%20d6786caa2ba94b7983a41b4ab876f28f/Java/JDBC%205a293e40988e49098409f3d58da691f4/实现%20CURD%20操作%20162f377a13594876ae8c70e0f68b96b6/Untitled%201.png)
        
- 使用 `Statment` 的示例代码：
    
    ```java
    package com.statement.crud;
    
    import java.io.InputStream;
    import java.lang.reflect.Field;
    import java.sql.Connection;
    import java.sql.DriverManager;
    import java.sql.ResultSet;
    import java.sql.ResultSetMetaData;
    import java.sql.SQLException;
    import java.sql.Statement;
    import java.util.Properties;
    import java.util.Scanner;
    
    import org.junit.Test;
    
    public class StatementTest {
    
    	// 使用Statement的弊端：需要拼写sql语句，并且存在SQL注入的问题
    	@Test
    	public void testLogin() {
    		Scanner scan = new Scanner(System.in);
    
    		System.out.print("用户名：");
    		String userName = scan.nextLine();
    		System.out.print("密   码：");
    		String password = scan.nextLine();
    
    		// SELECT user,password FROM user_table WHERE USER = '1' or ' AND PASSWORD = '
    		// ='1' or '1' = '1';
    		String sql = "SELECT user,password FROM user_table WHERE USER = '" + userName + "' AND PASSWORD = '" + password
    				+ "'";
    		User user = get(sql, User.class);
    		if (user != null) {
    			System.out.println("登陆成功!");
    		} else {
    			System.out.println("用户名或密码错误！");
    		}
    	}
    
    	// 使用Statement实现对数据表的查询操作
    	public <T> T get(String sql, Class<T> clazz) {
    		T t = null;
    
    		Connection conn = null;
    		Statement st = null;
    		ResultSet rs = null;
    		try {
    			// 1.加载配置文件
    			InputStream is = StatementTest.class.getClassLoader().getResourceAsStream("jdbc.properties");
    			Properties pros = new Properties();
    			pros.load(is);
    
    			// 2.读取配置信息
    			String user = pros.getProperty("user");
    			String password = pros.getProperty("password");
    			String url = pros.getProperty("url");
    			String driverClass = pros.getProperty("driverClass");
    
    			// 3.加载驱动
    			Class.forName(driverClass);
    
    			// 4.获取连接
    			conn = DriverManager.getConnection(url, user, password);
    
    			st = conn.createStatement();
    
    			rs = st.executeQuery(sql);
    
    			// 获取结果集的元数据
    			ResultSetMetaData rsmd = rs.getMetaData();
    
    			// 获取结果集的列数
    			int columnCount = rsmd.getColumnCount();
    
    			if (rs.next()) {
    
    				t = clazz.newInstance();
    
    				for (int i = 0; i < columnCount; i++) {
    					// //1. 获取列的名称
    					// String columnName = rsmd.getColumnName(i+1);
    
    					// 1. 获取列的别名
    					String columnName = rsmd.getColumnLabel(i + 1);
    
    					// 2. 根据列名获取对应数据表中的数据
    					Object columnVal = rs.getObject(columnName);
    
    					// 3. 将数据表中得到的数据，封装进对象
    					Field field = clazz.getDeclaredField(columnName);
    					field.setAccessible(true);
    					field.set(t, columnVal);
    				}
    				return t;
    			}
    		} catch (Exception e) {
    			e.printStackTrace();
    		} finally {
    			// 关闭资源
    			if (rs != null) {
    				try {
    					rs.close();
    				} catch (SQLException e) {
    					e.printStackTrace();
    				}
    			}
    			if (st != null) {
    				try {
    					st.close();
    				} catch (SQLException e) {
    					e.printStackTrace();
    				}
    			}
    
    			if (conn != null) {
    				try {
    					conn.close();
    				} catch (SQLException e) {
    					e.printStackTrace();
    				}
    			}
    		}
    
    		return null;
    	}
    
    }
    ```
    

在 `intellij` 中测试的时候发现默认是无法在控制台输入任何值的，需要更改虚拟机的设置。

![Untitled](Programming/Programming%20d6786caa2ba94b7983a41b4ab876f28f/Java/JDBC%205a293e40988e49098409f3d58da691f4/实现%20CURD%20操作%20162f377a13594876ae8c70e0f68b96b6/Untitled%202.png)

加入： `Deditable.java.test.console=true`

## 使用 `PreparedStatement`

由于我们每次操作都要连接和关闭资源，我们可以写在一个类里面方便调用。

- `util`类
    
    ```java
    package com.JDBCUtils;
    
    import java.io.IOException;
    import java.io.InputStream;
    import java.sql.*;
    import java.util.Properties;
    
    public class Utils {
        //获取数据库的连接
        public static Connection getConnection() throws Exception {
            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream("jdbc.properties");
    
            Properties pros = new Properties();
            pros.load(is);
    
            //从配置文件读取字段
            String url = pros.getProperty("url");
            String user = pros.getProperty("user");
            String password = pros.getProperty("password");
            String driverClass = pros.getProperty("driverClass");
            //System.out.println(url+' '+user+' '+password+' '+driverClass);
            //加载驱动
            Class.forName(driverClass);
            //获取连接
            return DriverManager.getConnection(url, user, password);
        }
        //关闭 连接 & statement
        public static void closeResource(Connection conn, Statement ps) {
            try {
                if (ps != null)
                    ps.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try {
                if (ps != null)
                    conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        public static void closeResource(Connection conn, Statement ps, ResultSet rs) {
            try {
                if (ps != null)
                    ps.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try {
                if (ps != null)
                    conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try{
                if(rs!=null)
                    rs.close();
            }catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
    ```
    

### 从增删改开始：

1. **增**
    1. 连接数据库
    2. 创建 `SQL` 语句，留下占位符
    3. 填充占位符（ `ps.setType()` ）
    4. 执行
    5. 关闭连接
    - 完整代码：
        
        ```java
        package com.preparedStatment.curd;
        
        import org.junit.Test;
        
        import java.io.IOException;
        import java.io.InputStream;
        import java.sql.Connection;
        import java.sql.DriverManager;
        import java.sql.PreparedStatement;
        import java.sql.SQLException;
        import java.util.Properties;
        
        public class PreparedStatmentUpdateTest {
            //add a row to a table
            @Test
            public void testInsert() {
                //get a loder from the system
                Connection conn = null;
                PreparedStatement ps = null;
                try {
                    InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream("jdbc.properties");
        
                    Properties pros = new Properties();
                    pros.load(is);
        
                    //从配置文件读取字段
                    String url = pros.getProperty("url");
                    String user = pros.getProperty("user");
                    String password = pros.getProperty("password");
                    String driverClass = pros.getProperty("driverClass");
                    //System.out.println(url+' '+user+' '+password+' '+driverClass);
                    //加载驱动
                    Class.forName(driverClass);
                    //获取连接
                    conn = DriverManager.getConnection(url, user, password);
        
                    System.out.println(conn);
                    //获取 preparedStatment 实例
                    String sql = "insert into user_table (user,password,balance) values(?,?,?)";//?是占位符
                    ps = conn.prepareStatement(sql);
                    //预编译sql语句
                    ps.setString(1, "hhh");
                    ps.setString(2, "2333333");
                    ps.setInt(3, 1000);
                    //执行 sql
                    ps.execute();
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    try {
                        if (ps != null)
                            ps.close();
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                    try {
                        if (ps != null)
                            conn.close();
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                }
                //关闭资源
        
            }
        }
        ```
        
    - 使用 `Util`
        
        ```java
        package com.preparedStatment.curd;
        
        import org.junit.Test;
        
        import java.io.IOException;
        import java.io.InputStream;
        import java.sql.Connection;
        import java.sql.DriverManager;
        import java.sql.PreparedStatement;
        import java.sql.SQLException;
        import java.util.Properties;
        
        public class PreparedStatmentUpdateTest {
            //add a row to a table
            @Test
            public void testInsert() throws Exception {
                Connection conn = null;
                PreparedStatement ps = null;
                //获取连接
                conn = com.JDBCUtils.Utils.getConnection();
                System.out.println(conn);
                //获取 preparedStatment 实例
                String sql = "insert into user_table (user,password,balance) values(?,?,?)";//?是占位符
                ps = conn.prepareStatement(sql);
                //预编译sql语句
                ps.setString(1, "hhhh");
                ps.setString(2, "2333333");
                ps.setInt(3, 1000);
                //执行 sql
                ps.execute();
                com.JDBCUtils.Utils.closeResource(conn, ps);
            }
        }
        ```
        
2. **改**
    - 使用 `util`
        
        ```java
        //modify a record
            @Test
            public void testUpdate() {
                Connection conn = null;
                PreparedStatement ps = null;
                try {
                    //1.得到数据库连接
                    conn = com.JDBCUtils.Utils.getConnection();
                    //2.预编译sql语句
                    String sql = "update user_table set balance = ? where user = ?";
                    ps = conn.prepareStatement(sql);
                    //3.填充占位符
                    ps.setString(2, "AA");
                    ps.setInt(1, 2000);
                    //4.执行
                    ps.execute();
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    //5.关闭资源
                    Utils.closeResource(conn, ps);
                }
        
            }
        ```
        
3. **删**
    - 使用 `util`
        
        ```java
        public void testDelete() {
                Connection conn = null;
                PreparedStatement ps = null;
                try {
                    //1.得到数据库连接
                    conn = com.JDBCUtils.Utils.getConnection();
                    //2.预编译sql语句
                    String sql = "delete from user_table  where user = ?";
                    ps = conn.prepareStatement(sql);
                    //3.填充占位符
                    ps.setString(1, "hhh");
                    //4.执行
                    ps.execute();
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    //5.关闭资源
                    Utils.closeResource(conn, ps);
                }
        
            }
        ```
        
4. **通用的增删改操作**
    
    **注意：** 
    
    1. 这个方法里面有参数的传递，需要使用更强大的单元测试 `import org.junit.jupiter.api.Test;`
    2. 如果需要得到增删改操作的结果，可以使用 `executeUpdate()` 替换 `execute()` 。其中 `executeUpdate()` 返回的使update操作影响的行数， `execute()` 返回是一个 `boolean` 值，如果有结果集就是 `true` 不是结果集是 `false` 。
    - 封装操作，void方法
        
        ```java
        //sql占位符的个数与可变形参长度相同
            public void update(String sql, Object... args) {
                Connection conn = null;
                PreparedStatement ps = null;
                try {
                    conn = com.JDBCUtils.Utils.getConnection();
                    ps = conn.prepareStatement(sql);
                    for (int i = 0; i < args.length; i++) {
                        ps.setObject(i + 1, args[i]);//注意参数的序号
                    }
                    ps.execute();
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    com.JDBCUtils.Utils.closeResource(conn, ps);
                }
            }
        ```
        
    - 封装操作，返回 int 方法
        
        ```java
            public int update(String sql, Object... args) {
                Connection conn = null;
                PreparedStatement ps = null;
                try {
                    conn = com.JDBCUtils.Utils.getConnection();
                    ps = conn.prepareStatement(sql);
                    for (int i = 0; i < args.length; i++) {
                        ps.setObject(i + 1, args[i]);//注意参数的序号
                    }
                    return ps.executeUpdate();
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    com.JDBCUtils.Utils.closeResource(conn, ps);
                }
        				return 0;//操作失败
            }
        ```
        
    - 效果
        - before
            
            ![Untitled](Programming/Programming%20d6786caa2ba94b7983a41b4ab876f28f/Java/JDBC%205a293e40988e49098409f3d58da691f4/实现%20CURD%20操作%20162f377a13594876ae8c70e0f68b96b6/Untitled%203.png)
            
        - code
            
            ```java
            public void commonTest() {
                    String sql = "delete from user_table where user = ?";
                    update(sql, "hhhh");
            
                    String sql1="insert into user_table (user,password,balance) value(?,?,?)";
                    update(sql1,"h_hh","2333232",2333);
            
                    String sql2="update user_table set balance = ? where user = ?";
                    update(sql2,2022,"AA");
                }
            ```
            
        - after
            
            ![Untitled](Programming/Programming%20d6786caa2ba94b7983a41b4ab876f28f/Java/JDBC%205a293e40988e49098409f3d58da691f4/实现%20CURD%20操作%20162f377a13594876ae8c70e0f68b96b6/Untitled%204.png)
            
5. **查**
    1. 由于要返回结果集，所以要操作结果对象。
    2. 按顺序读出 `resultSet` 里面的内容，它的 `next()` 方法在有下一个的时候会指向下一个，没有的话会返回 `false` ，和集合里面的迭代器不一样
    - c. 数据的对接
        
        
        | Java类型 | SQL类型 |
        | --- | --- |
        | boolean | BIT |
        | byte | TINYINT |
        | short | SMALLINT |
        | int | INTEGER |
        | long | BIGINT |
        | String | CHAR,VARCHAR,LONGVARCHAR |
        | byte   array | BINARY  ,    VAR BINARY |
        | java.sql.Date | DATE |
        | java.sql.Time | TIME |
        | java.sql.Timestamp | TIMESTAMP |
    1. 查询固定字段
        - 实例
            
            ```java
            package com.preparedStatment.curd;
            
            import com.bean.Users;
            import org.junit.Test;
            
            import java.sql.Connection;
            import java.sql.PreparedStatement;
            import java.sql.ResultSet;
            
            public class UserForQuery {
                @Test
                public void test1() {
                    Connection conn = null;
                    PreparedStatement ps = null;
                    ResultSet rs=null;
                    String sql = "select user,password,balance from user_table where user = ?";
                    try {
                        conn = com.JDBCUtils.Utils.getConnection();
                        ps = conn.prepareStatement(sql);
                        ps.setString(1,"AA");
                        rs = ps.executeQuery();
                        if (rs.next()) {
                            //获取数据字段值
                            String userName = rs.getString(1);
                            String userPasswd = rs.getString(2);
                            int balance = rs.getInt(3);
                            //将数据封装成一个对象
                            Users us = new Users(userName, userPasswd, balance);
                            System.out.println(us);
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    }finally {
                        com.JDBCUtils.Utils.closeResource(conn,ps,rs);
                    }
                }
            }
            ```
            
    2. 查询可变字段
        
        注意，列名和列数封装在元数据里面，而且通过属性名称改变变量需要使用 **反射** 。
        
        使用反射的时候注意类里面的属性要和 `SQL` 查询出来的字段名一致！如果不一致的话需要给列取别名。
        
        - 实例：
            
            ```java
            @Test
                //只用来查询表：user_table
                public Users queryForUT(String sql, Object[] args) {
                    Connection conn = null;
                    PreparedStatement ps = null;
                    try {
                        conn = com.JDBCUtils.Utils.getConnection();
                        ps = conn.prepareStatement(sql);
                        for (int i = 0; i < args.length; i++) {
                            ps.setObject(i + 1, args[i]);
                        }
                        ResultSet rs = ps.executeQuery();
                        //查询结果集的列数封装在 结果集元数据里面
                        ResultSetMetaData rsmd = rs.getMetaData();
                        int columnCount = rsmd.getColumnCount();
                        if (rs.next()) {
                            Users u = new Users();
                            for (int i = 0; i < columnCount; i++) {
                                //注意SQL和Java的下标转换
                                Object value = rs.getObject(i + 1);
                                //获取列名
                                String columnName = rsmd.getColumnName(i + 1);
                                //通过反射找到对应的属性
                                Field f = Users.class.getDeclaredField(columnName);
                                f.setAccessible(true);
                                f.set(u, value);
                            }
                            return u;
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    } finally {
                        com.JDBCUtils.Utils.closeResource(conn, ps);
                    }
                    return null;
                }
            ```
            
            使用实例：
            
            ```java
            public void testQueryForUT() {
                    String sql = "select user,password,balance from User_table where user = ?";
                    Users u = queryForUT(sql, "AA");
                    System.out.println(u);
                    sql = "select user,password,balance from User_table where balance = ?";
                    u = queryForUT(sql, 2022);
                    System.out.println(u);
                }
            ```
            
    3. 当表的字段名和 `Java` 中的属性名**不同**时候，可以通过给列取别名的方式使反射能正确找到变量的名称。
        
        **注意：** 要获取别名的话，应该从元数据得到 `columnLable` 而不是 `columnName` !
        
        - 实例：
            
            ```java
            @Test
                public Order testQuery1(String sql, Object... args) {
                    Connection conn = null;
                    PreparedStatement ps = null;
                    ResultSet rs = null;
                    try {
                        conn = Utils.getConnection();
            //            String sql = "select order_id,order_date,order_name from `order` where order_id = ?";
                        ps = conn.prepareStatement(sql);
                        for (int i = 0; i < args.length; i++) {
                            ps.setObject(i + 1, args[i]);
                        }
                        rs = ps.executeQuery();
                        ResultSetMetaData metaData = rs.getMetaData();
                        if (rs.next()) {
                            Order order = new Order();
                            for (int i = 0; i < metaData.getColumnCount(); i++) {
                                Object value = rs.getObject(i + 1);
                                //String columnName = metaData.getColumnName(i + 1);
                                //通过 getColumnLable 得到列的别名
                                String columnLabel = metaData.getColumnLabel(i + 1);
                                //通过反射赋值
                                Field field = Order.class.getDeclaredField(columnLabel);
                                field.setAccessible(true);
                                field.set(order, value);
                            }
                            return order;
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    } finally {
                        com.JDBCUtils.Utils.closeResource(conn, ps, rs);
                    }
                    return null;
                }
            
                @Test
                public void testQueryForOrder() {
            				//注意取别名
                    String sql = "select order_id orderId,order_date orderDate,order_name orderName from `order` where order_id = ?";
                    Order order = testQuery1(sql, 1);
                    System.out.println(order);
                }
            ```
            
    4. 通用表的查询，返回一条记录
        
        注意将确定的类使用泛型替代。
        
        - code
            
            ```java
            @Test
                public void testGetInstance() {
                    String sql = "select * from user_table where balance = ?";
                    Users users = getInstance(Users.class, sql, 2022);
                    System.out.println(users);
            
                    sql = "select order_name orderName,order_date orderDate from `order` where order_id = ?";
                    Order o = getInstance(Order.class, sql, 1);
                    System.out.println(o);
                }
            
                @Test
                //通用表的查询，返回一条记录
                public <T> T getInstance(Class<T> clazz, String sql, Object... args) {
                    Connection conn = null;
                    PreparedStatement ps = null;
                    ResultSet rs = null;
                    try {
                        conn = Utils.getConnection();
                        ps = conn.prepareStatement(sql);
                        for (int i = 0; i < args.length; i++) {
                            ps.setObject(i + 1, args[i]);
                        }
                        rs = ps.executeQuery();
                        ResultSetMetaData metaData = rs.getMetaData();
                        if (rs.next()) {
                            //动态的新建类
                            T t = clazz.newInstance();
                            for (int i = 0; i < metaData.getColumnCount(); i++) {
                                Object value = rs.getObject(i + 1);
                                //String columnName = metaData.getColumnName(i + 1);
                                //通过 getColumnLable 得到列的别名
                                String columnLabel = metaData.getColumnLabel(i + 1);
                                //通过反射赋值,注意使用**泛型对象**来获取反射
                                Field field = clazz.getDeclaredField(columnLabel);
                                field.setAccessible(true);
                                field.set(t, value);
                            }
                            //返回对象
                            return t;
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    } finally {
                        com.JDBCUtils.Utils.closeResource(conn, ps, rs);
                    }
                    return null;
                }
            ```
            
    5. 通用表查询，返回对象的集合
        - code
            
            ```java
            @Test
                //得到多个对象组合形成的集合
                public <T> List<T> getForList(Class<T> clazz, String sql, Object... args) {
                    Connection conn = null;
                    PreparedStatement ps = null;
                    ResultSet rs = null;
                    try {
                        conn = Utils.getConnection();
                        ps = conn.prepareStatement(sql);
                        for (int i = 0; i < args.length; i++) {
                            ps.setObject(i + 1, args[i]);
                        }
                        rs = ps.executeQuery();
                        ResultSetMetaData metaData = rs.getMetaData();
            
                        //创建集合对象
                        ArrayList<T> list = new ArrayList<>();
            
                        while (rs.next()) {
                            //动态的新建类
                            T t = clazz.newInstance();
                            for (int i = 0; i < metaData.getColumnCount(); i++) {
                                Object value = rs.getObject(i + 1);
                                //String columnName = metaData.getColumnName(i + 1);
                                //通过 getColumnLable 得到列的别名
                                String columnLabel = metaData.getColumnLabel(i + 1);
                                //通过反射赋值,注意使用泛型对象来获取反射
                                Field field = clazz.getDeclaredField(columnLabel);
                                field.setAccessible(true);
                                field.set(t, value);
                            }
                            list.add(t);//加入对象
                        }
                        //返回表
                        return list;
                    } catch (Exception e) {
                        e.printStackTrace();
                    } finally {
                        com.JDBCUtils.Utils.closeResource(conn, ps, rs);
                    }
                    return null;
                }
            ```
            
        - 测试实例
            
            ```java
            @Test
                public void testGetForList() {
                    String sql = "select * from user_table where balance > ?";
                    List<Users> list = getForList(Users.class, sql, 2);
            //        System.out.println(list);
                    list.forEach(System.out::println);
                }
            ```
            
    6. d