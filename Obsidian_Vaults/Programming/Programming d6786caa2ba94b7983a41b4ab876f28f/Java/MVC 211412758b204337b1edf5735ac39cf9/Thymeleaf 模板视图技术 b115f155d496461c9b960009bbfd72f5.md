# Thymeleaf 模板视图技术

SpringBoot官方推荐使用的视图模板技术，和SpringBoot完美整合。

1. 准备工作
    1. 导入 `Thymeleaf` 的依赖
        
        ```xml
        <dependency>
        			<groupId>org.thymeleaf</groupId>
        			<artifactId>thymeleaf</artifactId>
        			<version>3.0.15.RELEASE</version>
        </dependency>
        ```
        
    2. 新建一个 `Servlet` 类 `ViewBaseServlet` 作为基类
        - 基类代码
            
            ```java
            import org.thymeleaf.TemplateEngine;
            import org.thymeleaf.context.WebContext;
            import org.thymeleaf.templatemode.TemplateMode;
            import org.thymeleaf.templateresolver.ServletContextTemplateResolver;
            
            import javax.servlet.ServletContext;
            import javax.servlet.ServletException;
            import javax.servlet.http.HttpServlet;
            import javax.servlet.http.HttpServletRequest;
            import javax.servlet.http.HttpServletResponse;
            import java.io.IOException;
            
            public class ViewBaseServlet extends HttpServlet {
            
                private TemplateEngine templateEngine;
            
                @Override
                public void init() throws ServletException {
            
                    // 1.获取ServletContext对象
                    ServletContext servletContext = this.getServletContext();
            
                    // 2.创建Thymeleaf解析器对象
                    ServletContextTemplateResolver templateResolver = new ServletContextTemplateResolver(servletContext);
            
                    // 3.给解析器对象设置参数
                    // ①HTML是默认模式，明确设置是为了代码更容易理解
                    templateResolver.setTemplateMode(TemplateMode.HTML);
            
                    // ②设置前缀
                    String viewPrefix = servletContext.getInitParameter("view-prefix");
            
                    templateResolver.setPrefix(viewPrefix);
            
                    // ③设置后缀
                    String viewSuffix = servletContext.getInitParameter("view-suffix");
            
                    templateResolver.setSuffix(viewSuffix);
            
                    // ④设置缓存过期时间（毫秒）
                    templateResolver.setCacheTTLMs(60000L);
            
                    // ⑤设置是否缓存
                    templateResolver.setCacheable(true);
            
                    // ⑥设置服务器端编码方式
                    templateResolver.setCharacterEncoding("utf-8");
            
                    // 4.创建模板引擎对象
                    templateEngine = new TemplateEngine();
            
                    // 5.给模板引擎对象设置模板解析器
                    templateEngine.setTemplateResolver(templateResolver);
            
                }
            
                protected void processTemplate(String templateName, HttpServletRequest req, HttpServletResponse resp) throws IOException {
                    // 1.设置响应体内容类型和字符集
                    resp.setContentType("text/html;charset=UTF-8");
            
                    // 2.创建WebContext对象
                    WebContext webContext = new WebContext(req, resp, getServletContext());
            
                    // 3.处理模板数据
                    templateEngine.process(templateName, webContext, resp.getWriter());
                }
            }
            ```
            
    3. 在 `web.xml` 中加入配置
        
        ```xml
        <!-- 上下文参数 -->
        <context-param>
            <param-name>view-prefix</param-name>  <!-- 配置视图前缀 -->
            <param-value>/</param-value>
        </context-param>
        <context-param>
            <param-name>view-suffix</param-name>  <!-- 配置视图后缀 -->
            <param-value>.html</param-value>
        </context-param>
        ```
        
    4. 使一个 `Servlet` 类继承  `ViewBaseServlet` 相当于基础 `HttpServlet`
        
        ```java
        @WebServlet("/index")
        public class AddServlet extends ViewBaseServlet {
            @Override
            protected void doGet(HttpServletRequest request, HttpServletResponse response) 
        																						throws ServletException, IOException {
                super.processTemplate("index",request,response);
            }
        }
        ```
        
2. 快速上手
    1. 常用标签： `th:if` `th:unless` ( `else if` ) , `th:text` `th:each` 
        
        要使用标签，需引入外部名称空间： 
        
        `<html lang="en" xmlns:th="http://www.thymeleaf.org">`
        
    2. 数据绑定方式：设置属性值
        
        ```java
        public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
                String sql = "select uName,uTel,uAge from users";
                List<User> list = Utils.getForList(User.class, sql);
                HttpSession session = request.getSession();
                session.setAttribute("userList", list);//绑定数据
                super.processTemplate("index", request, response);
            }
        ```
        
3. 与 `JDBC` 配合
    1. 数据访问方式
        1. 使用 `${value}` 的方式来访问数据
            
            例如保存在 `session` 中的数据可以按下面方式访问：
            
            ```html
            <tr th:unless="${#lists.isEmpty(session.userList)}" th:each="user : ${session.userList}">
            			<td th:text="${user.uName}"></td>
                  <td th:text="${user.uTel}"></td>
                  <td th:text="${user.uAge}"></td>
            </tr>
            ```
            
        2. 使用 `th:object` 指定访问对象， `*{属性名}` 获取值
            - E.g.
                
                ```html
                <form method="post">
                        <table class="table table-striped" th:object="${session.user}">
                            <thead>
                            <tr>
                                <th colspan="2" style="text-align: center">修改用户信息</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td class="p-3 col-2">姓名：</td>
                                <td><label>
                                    <input type="text" style="width: 550px" class="form-control" th:value="*{uName}" name="uName">
                                </label></td>
                            </tr>
                            <tr>
                                <td class="p-3 col-2">年龄：</td>
                                <td><label>
                                    <input type="number" style="width: 550px" class="form-control" th:value="*{uAge}" name="uAge">
                                </label></td>
                            </tr>
                            <tr>
                                <td class="p-3 col-2">电话：</td>
                                <td><label>
                                    <input type="tel" style="width: 550px" class="form-control" th:value="*{uTel}" name="uTel">
                                </label></td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <button type="submit" class=" btn btn-primary ">Submit</button>
                                </td>
                            </tr>
                
                            </tbody>
                
                        </table>
                    </form>
                ```
                
        3. 使用 `th:href` 来指定跳转地址
            
            例如： `th:href="@{/edit.do(id=${user.id})}"`
            
            - `@{}` 代表当前的地址
            - `(id=x)` 会被自动翻译为 `?id=x` 填入跳转地址
            - 有多个参数就用逗号隔开：`th:href="@{/edit.do(id=${user.id},age=${user.uAge})}"` 然后就会得到 `/edit.do?id=2&age=12`
    2.